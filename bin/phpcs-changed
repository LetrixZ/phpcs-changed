#!/usr/bin/env php
<?php
// Make sure this script is being run over the PHP CLI!
if ('cli' !== php_sapi_name()) {
	return;
}

require_once __DIR__ . '/../index.php';

use function PhpcsChanged\getNewPhpcsMessages;
use PhpcsChanged\PhpcsMessages;
use function PhpcsChanged\Cli\{printHelp, printErrorAndExit, getDebug, getChangedMessagesFromDiff, getReporter};

$options = getopt(
	'h',
	[
		'help',
		'diff:',
		'phpcs-orig:',
		'phpcs-new:',
		'svn:',
		'standard:',
		'report:',
		'debug',
	]
);

if (isset($options['h']) || isset($options['help'])) {
	printHelp();
}

$debug = getDebug(isset($options['debug']));
$debug('Running...');

$reportType = $options['report'] ?? 'json';
$diffFile = $options['diff'] ?? null;
$phpcsOldFile = $options['phpcs-orig'] ?? null;
$phpcsNewFile = $options['phpcs-new'] ?? null;

if ($diffFile && $phpcsOldFile && $phpcsNewFile) {
	$messages = getChangedMessagesFromDiff($diffFile, $phpcsOldFile, $phpcsNewFile);
	$reporter = getReporter($reportType);
	echo $reporter->getFormattedMessages($messages);
	exit($reporter->getExitCode($messages));
}

$svnFile = $options['svn'] ?? null;
if ($svnFile) {
	$svn = 'svn';
	$phpcs = 'phpcs';
	$phpcsStandard = $options['standard'] ?? null;
	$phpcsStandardOption = $phpcsStandard ? ' --standard=' . escapeshellarg($phpcsStandard) : '';
	if (! is_readable($svnFile)) {
		printErrorAndExit("Cannot read file '{$svnFile}'");
	}
	$unifiedDiffCommand = "{$svn} diff " . escapeshellarg($svnFile);
	$debug('running diff command:', $unifiedDiffCommand);
	$unifiedDiff = shell_exec($unifiedDiffCommand);
	if (! $unifiedDiff) {
		$debug("Cannot get svn diff for file '{$svnFile}'; skipping");
		exit(0);
	}
	$debug('diff command output:', $unifiedDiff);
	$oldFilePhpcsOutputCommand = "${svn} cat " . escapeshellarg($svnFile) . " | {$phpcs} --report=json" . $phpcsStandardOption;
	$debug('running orig phpcs command:', $oldFilePhpcsOutputCommand);
	$oldFilePhpcsOutput = shell_exec($oldFilePhpcsOutputCommand);
	if (! $oldFilePhpcsOutput) {
		printErrorAndExit("Cannot get old phpcs output for file '{$svnFile}'");
	}
	$debug('orig phpcs command output:', $oldFilePhpcsOutput);
	$newFilePhpcsOutputCommand = "cat " . escapeshellarg($svnFile) . " | {$phpcs} --report=json" . $phpcsStandardOption;
	$debug('running new phpcs command:', $newFilePhpcsOutputCommand);
	$newFilePhpcsOutput = shell_exec($newFilePhpcsOutputCommand);
	if (! $newFilePhpcsOutput) {
		printErrorAndExit("Cannot get new phpcs output for file '{$svnFile}'");
	}
	$debug('new phpcs command output:', $newFilePhpcsOutput);
	$debug('processing data...');
	$messages = getNewPhpcsMessages($unifiedDiff, PhpcsMessages::fromPhpcsJson($oldFilePhpcsOutput), PhpcsMessages::fromPhpcsJson($newFilePhpcsOutput));
	$reporter = getReporter($reportType);
	echo $reporter->getFormattedMessages($messages);
	exit($reporter->getExitCode($messages));
}

printHelp();
